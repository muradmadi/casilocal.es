---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

// Fetch all spots and find the highest rated one
const spots = await getCollection('spots');
const sortedSpots = spots.sort((a, b) => b.data.metrics.casi_score - a.data.metrics.casi_score);
const featuredSpot = sortedSpots[0];

// Fallback if no spots exist (shouldn't happen in prod but good for safety)
if (!featuredSpot) {
  throw new Error("No spots found in CMS");
}

const { title, neighborhood, metrics } = featuredSpot.data;
const spotUrl = `/spots/${featuredSpot.id}/`;

// coverImage is always an object with image/alt/source when defined
const coverImage = featuredSpot.data.coverImage || null;

// Construct a dynamic description based on metrics since we don't have a dedicated excerpt field
const description = `A top-rated workspace in ${neighborhood} with ${metrics.wifi_speed} internet, ${metrics.noise_level} acoustics, and a Casi Score of ${metrics.casi_score}/10.`;
---
<section class="py-24 border-b-2 border-dotted border-line px-4 lg:px-6 bg-bg-main">
    <div class="max-w-screen-xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-24 items-center">
        <!-- Image Side -->
        <a href={spotUrl} class="block relative group cursor-pointer aspect-[4/3] lg:aspect-square overflow-hidden rounded-sm border-2 border-line-heavy shadow-card hover:shadow-card-hover transition-all duration-300 ease-mechanical order-2 lg:order-1">
             {coverImage?.image ? (
                <Image 
                    src={coverImage.image} 
                    alt={coverImage.alt || `Interior of ${title}`}
                    width={800}
                    format="webp"
                    class="w-full h-full object-cover filter grayscale hover:grayscale-0 transition-all duration-700" 
                />
             ) : (
                <div class="w-full h-full bg-line/10 flex items-center justify-center">
                    <span class="font-mono text-xs text-text-main/40 uppercase">No Image Available</span>
                </div>
             )}
        </a>

        <!-- Copy Side -->
        <div class="space-y-8 order-1 lg:order-2">
            <div class="flex items-center gap-3">
                <span class="w-3 h-3 bg-text-brand rounded-full animate-pulse"></span>
                <span class="font-mono text-xs font-bold uppercase tracking-widest text-text-brand mb-0.5">
                    Editor's Pick Â· {neighborhood}
                </span>
            </div>
            
            <h2 class="font-display font-black text-5xl md:text-7xl tracking-tighter leading-[0.9]">
                {title}: The Gold Standard for <span class="italic display-italic text-text-main">Deep Work</span>.
            </h2>
            
            <p class="font-body text-xl text-text-main/70 leading-relaxed max-w-lg">
                {description}
            </p>

            <div class="grid grid-cols-3 gap-4 border-t border-b border-line py-4">
                <div>
                    <span class="block font-mono text-[10px] uppercase text-text-main/40 tracking-widest">Speed</span>
                    <span class="font-bold capitalize">{metrics.wifi_speed}</span>
                </div>
                <div>
                    <span class="block font-mono text-[10px] uppercase text-text-main/40 tracking-widest">Noise</span>
                    <span class="font-bold capitalize">{metrics.noise_level}</span>
                </div>
                <div>
                    <span class="block font-mono text-[10px] uppercase text-text-main/40 tracking-widest">Power</span>
                    <span class="font-bold">{metrics.plug_access ? "Yes" : "Limited"}</span>
                </div>
            </div>
            
            <div class="pt-4">
                <a href={spotUrl} class="inline-flex items-center gap-2 font-mono text-sm font-bold uppercase text-text-main hover:text-action transition-colors group border-b border-text-main hover:border-action pb-1">
                    Read the Analysis 
                    <span class="group-hover:translate-x-1 transition-transform">-></span>
                </a>
            </div>
        </div>
    </div>
</section>
