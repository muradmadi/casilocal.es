---
import { Wifi, Volume2, Plug } from 'lucide-react';
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';

interface Props {
  spot: CollectionEntry<'spots'>;
  mapsUrl: string;
  author?: CollectionEntry<'authors'> | null;
}

const { spot, mapsUrl, author } = Astro.props;
const { data } = spot;

// WiFi speed to signal bars (0-4)
const wifiSignalBars: Record<string, number> = {
  'flynet': 4,
  'reliable': 3,
  'spotty': 2,
  'detox': 0,
};
const signalCount = wifiSignalBars[data.metrics.wifi_speed] ?? 2;

// Noise level labels
const noiseLabelMap: Record<string, string> = {
  'silence': 'Library Quiet',
  'hum': 'Café Buzz',
  'chaos': 'Market Chaos',
};
const noiseLabel = noiseLabelMap[data.metrics.noise_level] ?? data.metrics.noise_level;

// Rent meter (0-3 bars based on coffee price)
const rentBars = data.metrics.coffee_price < 2.0 ? 1 
               : data.metrics.coffee_price < 3.0 ? 2 
               : data.metrics.coffee_price < 4.0 ? 3 
               : 4;
---

<div class="space-y-8">
  
  <!-- Vital Stats (Definition List) -->
  <dl class="space-y-6">
    
    <!-- WiFi as Signal Bars -->
    <div class="pb-4 border-b border-dotted border-ink/20">
      <dt class="font-mono text-[10px] uppercase tracking-widest text-text-main/50 mb-2 flex items-center gap-2">
        <Wifi className="w-3 h-3" />
        WiFi Speed
      </dt>
      <dd class="flex items-end gap-1 h-6">
        {[1, 2, 3, 4].map((bar) => (
          <div 
            class={`w-3 rounded-xs transition-colors ${
              bar <= signalCount 
                ? 'bg-status-good' 
                : 'bg-text-main/10'
            }`}
            style={`height: ${bar * 5 + 2}px`}
          />
        ))}
        <span class="ml-2 font-body text-sm capitalize text-text-main/70">
          {data.metrics.wifi_speed === 'detox' ? 'No WiFi' : data.metrics.wifi_speed}
        </span>
      </dd>
    </div>

    <!-- Noise Level -->
    <div class="pb-4 border-b border-dotted border-ink/20">
      <dt class="font-mono text-[10px] uppercase tracking-widest text-text-main/50 mb-2 flex items-center gap-2">
        <Volume2 className="w-3 h-3" />
        Noise Level
      </dt>
      <dd class="font-display text-xl font-bold text-text-main">
        {noiseLabel}
      </dd>
    </div>

    <!-- Plugs -->
    <div class="pb-4 border-b border-dotted border-ink/20">
      <dt class="font-mono text-[10px] uppercase tracking-widest text-text-main/50 mb-2 flex items-center gap-2">
        <Plug className="w-3 h-3" />
        Plug Access
      </dt>
      <dd class="flex items-center gap-2">
        <div class={`w-3 h-3 rounded-full ${data.metrics.plug_access ? 'bg-status-good' : 'bg-status-bad'}`}></div>
        <span class="font-display text-lg font-bold text-text-main">
          {data.metrics.plug_access ? 'Yes' : 'No'}
        </span>
      </dd>
    </div>

    <!-- Rent Meter (Coffee Price) -->
    <div class="pb-4 border-b border-dotted border-ink/20">
      <dt class="font-mono text-[10px] uppercase tracking-widest text-text-main/50 mb-2">
        "Rent" (Coffee Price)
      </dt>
      <dd>
        <div class="flex items-center gap-2 mb-1">
          <span class="font-display text-2xl font-bold text-text-main">
            €{data.metrics.coffee_price.toFixed(2)}
          </span>
        </div>
        <!-- Visual bar -->
        <div class="flex items-center gap-1 mt-2">
          {[1, 2, 3, 4].map((bar) => (
            <div 
              class={`h-2 w-6 rounded-xs ${
                bar <= rentBars 
                  ? bar <= 2 ? 'bg-status-good' : bar === 3 ? 'bg-brass' : 'bg-status-bad'
                  : 'bg-text-main/10'
              }`}
            />
          ))}
          <span class="ml-2 font-mono text-[10px] text-text-main/50 uppercase">
            {rentBars <= 2 ? 'Budget OK' : rentBars === 3 ? 'Mid Range' : 'Pricey'}
          </span>
        </div>
      </dd>
    </div>

  </dl>

  <!-- GET DIRECTIONS Button & Coords -->
  <div>
    <a 
      href={mapsUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="btn-primary w-full flex items-center justify-center py-4 text-sm font-display font-black uppercase tracking-widest shadow-button hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all duration-100 ease-mechanical"
      aria-label="Get directions to this spot"
    >
      Get Directions
    </a>
    <p class="font-mono text-[10px] text-text-main/30 text-center mt-3">
      {data.metrics.coordinates.lat.toFixed(6)}, {data.metrics.coordinates.long.toFixed(6)}
    </p>
  </div>

  <!-- Review By (Author) -->
  {author && (
    <div class="pt-8 border-t-2 border-dotted border-ink/20">
      <p class="font-mono text-[10px] uppercase tracking-widest text-text-main/50 mb-3">
        Review by
      </p>
      <a href={`/authors/${author.id}/`} class="flex items-center gap-3 group">
        <div class="w-10 h-10 rounded-full overflow-hidden border border-ink/20 flex-shrink-0 group-hover:border-action transition-colors">
          <Image 
            src={author.data.avatar} 
            alt={author.data.name}
            class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-300"
          />
        </div>
        <div>
          <p class="font-display text-lg font-bold text-text-main leading-tight group-hover:text-action transition-colors border-b border-transparent group-hover:border-action inline-block">
            {author.data.name}
          </p>
          <p class="font-mono text-[10px] text-text-main/50 uppercase tracking-wider">
            {author.data.role}
          </p>
        </div>
      </a>
    </div>
  )}

</div>
