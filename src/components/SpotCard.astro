---
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import MetricBadge from './MetricBadge.astro';

interface Props {
  spot: CollectionEntry<'spots'>;
}

const { spot } = Astro.props;
const { data, id } = spot;

// coverImage is always an object with image/alt/source when defined
const coverImage = data.coverImage || null;
---

<article 
  data-spot-card
  data-neighborhood={data.neighborhood}
  data-noise={data.metrics.noise_level}
  data-plugs={data.metrics.plug_access.toString()}
  class="group relative overflow-hidden bg-bg-main border border-line-heavy rounded-sm @container shadow-card hover:shadow-card-hover hover:-translate-y-1 transition-all duration-300 ease-mechanical"
>
  
  <!-- Image Header -->
  <div class="aspect-[3/2] overflow-hidden relative border-b border-line-heavy">
    {coverImage?.image ? (
      <Image 
        src={coverImage.image} 
        alt={coverImage.alt || data.title}
        class="object-cover w-full h-full grayscale group-hover:grayscale-0 transition-all duration-300 ease-mechanical"
      />
    ) : (
      <div class="w-full h-full bg-gradient-to-br from-bg-alt to-bg-main flex items-center justify-center">
        <span class="font-display text-4xl text-text-main/10">â˜•</span>
      </div>
    )}
    
    <!-- Casi Score Stamp -->
    <div class="absolute top-4 right-4 w-12 h-12 flex items-center justify-center rounded-full bg-action text-action-fg font-display text-lg font-bold rotate-12 shadow-button border border-line-heavy">
      {data.metrics.casi_score}
    </div>
  </div>

  <!-- Content Body -->
  <div class="p-4 space-y-4 bg-grain">
    <!-- Header -->
    <div class="space-y-1">
      <p class="text-xs uppercase tracking-widest text-text-sec opacity-60 font-body">
        {data.neighborhood}
      </p>
      <h3 class="font-display text-xl leading-tight text-text-main group-hover:text-text-brand transition-colors text-bleed">
        <a href={`/spots/${id}/`} class="after:absolute after:inset-0 focus:outline-none focus:ring-2 focus:ring-action rounded-sm">
            {data.title}
        </a>
      </h3>
    </div>

    <!-- Dashboard -->
    <div class="grid grid-cols-2 gap-2 pt-2 border-t-2 border-dotted border-line-heavy/20">
      <!-- Col 1: Metrics -->
      <div class="space-y-2 flex flex-col items-start">
        <MetricBadge type="wifi" value={data.metrics.wifi_speed} />
        <MetricBadge type="noise" value={data.metrics.noise_level} />
      </div>

      <!-- Col 2: Price & Plug -->
      <div class="space-y-2 flex flex-col items-end justify-between">
         <div class="flex items-center gap-1">
             <div class="flex gap-0.5">
                 <div class={`w-1.5 h-3 rounded-xs ${data.metrics.coffee_price >= 1.5 ? 'bg-text-main' : 'bg-text-main/20'}`}></div>
                 <div class={`w-1.5 h-3 rounded-xs ${data.metrics.coffee_price >= 2.5 ? 'bg-text-main' : 'bg-text-main/20'}`}></div>
                 <div class={`w-1.5 h-3 rounded-xs ${data.metrics.coffee_price >= 3.5 ? 'bg-text-main' : 'bg-text-main/20'}`}></div>
             </div>
         </div>
         <MetricBadge type="plug" value={data.metrics.plug_access} />
      </div>
    </div>
  </div>
</article>

<style>
  /* Removing custom style block as we are using Tailwind utilities now defined in theme */
</style>
