---
import { getCollection, render, getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import SpotSidebar from '../../components/SpotSidebar.astro';
import SpotCard from '../../components/SpotCard.astro';
import { Image, getImage } from 'astro:assets';

export async function getStaticPaths() {
  const spots = await getCollection('spots');
  return spots.map(spot => ({
    params: { slug: spot.id },
    props: { spot, allSpots: spots },
  }));
}

const { spot, allSpots } = Astro.props;
const { data, id } = spot;
const { Content } = await render(spot);

// Create optimized OG Image (1200x630)
const coverImage = data.coverImage || null;
let ogImageSrc = undefined;

if (coverImage?.image) {
  const optimizedOg = await getImage({
    src: coverImage.image,
    format: 'jpg',
    width: 1200,
    height: 630,
    quality: 80
  });
  ogImageSrc = optimizedOg.src;
}

// Get nearby alternatives (same neighborhood, different spot)
const nearbySpots = allSpots
  .filter(s => s.data.neighborhood === data.neighborhood && s.id !== id)
  .slice(0, 2);

// Get author if specified
const author = data.author ? await getEntry('authors', data.author) : null;

const title = `${data.title} | ${data.neighborhood} - CasiLocal`;
const description = `Review of ${data.title} in ${data.neighborhood}. Wifi: ${data.metrics.wifi_speed}, Noise: ${data.metrics.noise_level}. CasiScore: ${data.metrics.casi_score}/10.`;

// Google Maps directions URL
const isAddressUrl = data.address?.startsWith('http');
const mapsUrl = isAddressUrl ? data.address : `https://www.google.com/maps/dir/?api=1&destination=${data.metrics.coordinates.lat},${data.metrics.coordinates.long}`;

// coverImage is always an object with image/alt/source when defined
const coverImage = data.coverImage || null;

// JSON-LD Schema Construction
const schema = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness", // or CafeOrCoffeeShop if discernible, usually LocalBusiness is safe
  "name": data.title,
  "image": ogImageSrc ? new URL(ogImageSrc, Astro.site).toString() : undefined,
  "address": !isAddressUrl ? data.address : undefined, // Don't put URL in address field of schema
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": data.metrics.coordinates.lat,
    "longitude": data.metrics.coordinates.long
  },
  "url": Astro.url.href,
  "priceRange": data.metrics.price === 'cheap' ? '€' : data.metrics.price === 'moderate' ? '€€' : '€€€',
  "amenityFeature": [
    {
      "@type": "LocationFeatureSpecification",
      "name": "WiFi Speed",
      "value": data.metrics.wifi_speed
    },
    {
      "@type": "LocationFeatureSpecification",
      "name": "Noise Level",
      "value": data.metrics.noise_level
    },
    {
      "@type": "LocationFeatureSpecification",
      "name": "Plug Access",
      "value": data.metrics.plug_access ? "Available" : "No Plugs"
    }
  ],
  "review": {
    "@type": "Review",
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": data.metrics.casi_score,
      "bestRating": "10",
      "worstRating": "1"
    },
    "author": {
      "@type": "Person",
      "name": author ? author.data.name : "CasiLocal Curators"
    },
    "reviewBody": description
  }
};
---

<Layout title={title} description={description} image={ogImageSrc} type="article" schema={schema}>
  
  <!-- ZONE A: Title Block (Full Width) -->
  <header class="border-b border-ink px-6 py-8 lg:px-12 lg:py-12 bg-bg-main relative">
    <div class="max-w-screen-xl mx-auto">
      <!-- Back Link -->
      <a href="/spots/" class="font-mono text-xs uppercase tracking-widest text-text-main/50 hover:text-action transition-colors mb-6 inline-block">
        ← Back to Index
      </a>
      
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
        <!-- Name & Sub-Data -->
        <div class="flex-1">
          <h1 class="font-display text-5xl lg:text-7xl font-black leading-[0.85] tracking-tight text-text-main max-w-2xl">
            {data.title}
          </h1>
          
          <div class="mt-4 pt-4 border-t-2 border-dotted border-ink/20 flex flex-wrap items-center gap-x-4 gap-y-2">
            <span class="font-mono text-sm uppercase tracking-widest text-text-main/70">
              {data.neighborhood}
            </span>
            {data.address && !isAddressUrl && (
              <>
                <span class="text-text-main/30">•</span>
                <span class="font-body text-sm text-text-main/60">{data.address}</span>
              </>
            )}
          </div>
        </div>
        
        <!-- CasiLocal Certified Stamp -->
        <div class="flex-shrink-0 relative w-28 h-28 lg:w-36 lg:h-36">
          <div class="absolute inset-0 rounded-full border-4 border-ember rotate-12 flex flex-col items-center justify-center bg-paper shadow-lg">
            <div class="font-display text-3xl lg:text-4xl font-black text-ember leading-none">
              {data.metrics.casi_score}
            </div>
            <div class="font-mono text-[10px] uppercase tracking-wider text-ember/70 mt-1">
              /10
            </div>
            <div class="absolute bottom-3 font-mono text-[8px] uppercase tracking-widest text-ember/50">
              Certified
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Container with Spine -->
  <div class="max-w-screen-xl mx-auto flex flex-col lg:flex-row min-h-screen">
    
    <!-- ZONE B: Spec Sheet (Sticky Sidebar) - The "Spine" -->
    <aside class="lg:w-1/3 lg:border-r border-ink lg:sticky lg:top-0 lg:h-screen lg:overflow-y-auto bg-bg-main p-6 lg:p-8">
      <SpotSidebar spot={spot} mapsUrl={mapsUrl} author={author} />
    </aside>

    <!-- ZONE C: Field Notes (Main Content) -->
    <main class="lg:w-2/3 p-6 lg:p-12 bg-bg-main">
      
      <!-- Prose Content -->
      <article class="prose prose-lg max-w-none text-text-main 
        prose-headings:font-display prose-headings:uppercase prose-headings:text-text-main prose-headings:border-b-2 prose-headings:border-dotted prose-headings:border-ink/20 prose-headings:pb-2
        prose-p:font-body prose-p:leading-relaxed
        prose-a:text-action prose-a:underline hover:prose-a:text-text-main
        prose-blockquote:border-l-4 prose-blockquote:border-brass prose-blockquote:bg-brass/20 prose-blockquote:py-3 prose-blockquote:px-4 prose-blockquote:not-italic prose-blockquote:font-display prose-blockquote:text-ink
        prose-hr:border-t-2 prose-hr:border-dashed prose-hr:border-ink/30 prose-hr:my-8"
      >
        <Content />
      </article>

      <!-- Evidence Grid (includes Cover + Gallery) -->
      {(coverImage?.image || (data.gallery && data.gallery.length > 0)) && (
        <section class="mt-12 pt-8 border-t-2 border-dashed border-ink/30">
          <h2 class="font-display text-2xl uppercase mb-6 text-text-main flex items-center gap-3">
            Evidence
          </h2>


          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="gallery">
            
            {/* 1. Cover Image moved here */}
            {coverImage?.image && (
               <a 
                 href={coverImage.image.src} 
                 data-pswp-width={coverImage.image.width}
                 data-pswp-height={coverImage.image.height}
                 target="_blank" 
                 class="relative group block overflow-hidden cursor-zoom-in"
               >
                <Image 
                  src={coverImage.image} 
                  alt={coverImage.alt || `${data.title} Cover`}
                  format="webp"
                  quality={80}
                  width={1200}
                  class="w-full aspect-video object-cover border border-ink grayscale group-hover:grayscale-0 transition-all duration-300 rounded-sm"
                />
              </a>
            )}

            {/* 2. Gallery Images */}
            {data.gallery && data.gallery.map((item: any, index: number) => {
               const img = 'image' in item ? item.image : item;
               const alt = 'alt' in item && item.alt ? item.alt : `${data.title} gallery image ${index + 1}`;
               return (
                <a 
                  href={img.src} 
                  data-pswp-width={img.width}
                  data-pswp-height={img.height}
                  target="_blank" 
                  class="relative group block overflow-hidden cursor-zoom-in"
                >
                  <Image 
                    src={img} 
                    alt={alt}
                    format="webp"
                    quality={80}
                    width={1200}
                    class="w-full aspect-video object-cover border border-ink grayscale group-hover:grayscale-0 transition-all duration-300 rounded-sm"
                  />
                </a>
               );
            })}
          </div>
        </section>
      )}

      <link rel="stylesheet" href="https://unpkg.com/photoswipe@5.4.3/dist/photoswipe.css">
      <script type="module">
        import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe@5.4.3/dist/photoswipe-lightbox.esm.js';
        const lightbox = new PhotoSwipeLightbox({
          gallery: '#gallery',
          children: 'a',
          pswpModule: () => import('https://unpkg.com/photoswipe@5.4.3/dist/photoswipe.esm.js')
        });
        lightbox.init();
      </script>

      <!-- ZONE D: Next Assignment (Nearby Alternatives) -->
      {nearbySpots.length > 0 && (
        <section class="mt-16 pt-10 border-t-2 border-ink">
          <h2 class="font-display text-2xl uppercase mb-2 text-text-main">
            Nearby Alternatives
          </h2>
          <p class="font-mono text-xs text-text-main/50 uppercase tracking-wider mb-8">
            Other spots in {data.neighborhood}
          </p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {nearbySpots.map(nearbySpot => (
              <SpotCard spot={nearbySpot} />
            ))}
          </div>
        </section>
      )}

      <!-- No Nearby? Suggest explore -->
      {nearbySpots.length === 0 && (
        <section class="mt-16 pt-10 border-t-2 border-ink text-center">
          <p class="font-mono text-sm text-text-main/50 uppercase tracking-wider mb-4">
            First scout in {data.neighborhood}
          </p>
          <a href="/spots/" class="btn-primary inline-block">
            Explore All Spots
          </a>
        </section>
      )}
    </main>
  </div>
</Layout>
